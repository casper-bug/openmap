<!DOCTYPE html>
<html>
<head>
    <title>Complete OSM Navigation with Live GPS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            background: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .control-btn:hover {
            background: #f5f5f5;
        }
        
        .route-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            width: 300px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .route-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .route-btn {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .nav-btn {
            background: #2196F3;
        }
        
        .nav-btn:hover {
            background: #0b7dda;
        }
        
        .stop-btn {
            background: #f44336;
        }
        
        .stop-btn:hover {
            background: #da190b;
        }
        
        .route-swap {
            text-align: center;
            margin: 5px 0;
            color: #666;
            cursor: pointer;
        }
        
        .route-swap:hover {
            color: #333;
        }
        
        .route-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: none;
        }
        
        #search-results {
            position: absolute;
            background: white;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 30px);
            z-index: 10;
            display: none;
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .route-instruction {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            cursor: pointer;
        }
        
        .route-instruction:hover {
            background: #f5f5f5;
        }
        
        .route-instruction.active {
            background: #e3f2fd;
        }
        
        .route-summary {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .navigation-popup {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            display: none;
        }
        
        .nav-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .nav-popup-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .nav-popup-close {
            cursor: pointer;
            color: #666;
        }
        
        .nav-popup-content {
            margin-bottom: 10px;
        }
        
        .nav-popup-distance {
            color: #666;
            font-size: 14px;
        }
        
        .nav-popup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .nav-action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .nav-next-btn {
            background: #4CAF50;
            color: white;
        }
        
        .nav-prev-btn {
            background: #f5f5f5;
        }
        
        .nav-stop-btn {
            background: #f44336;
            color: white;
        }
        
        .current-position-marker {
            background: #2196F3;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .gps-accuracy {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-size: 12px;
            display: none;
        }
        
        /* GPS position marker */
        .gps-marker {
            background: #4285F4;
            border-radius: 50%;
            border: 2px solid white;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .gps-marker::after {
            content: "";
            position: absolute;
            top: -8px;
            left: -8px;
            width: 30px;
            height: 30px;
            border: 2px solid #4285F4;
            border-radius: 50%;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.3; }
            70% { transform: scale(1.3); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="map-controls">
        <button id="gps-track" class="control-btn">
            <i class="fas fa-location-arrow"></i>
            <span>Follow Me</span>
        </button>
        
        <button id="theme-toggle" class="control-btn">
            <i class="fas fa-moon"></i>
            <span>Night Mode</span>
        </button>
        
        <button id="fullscreen-btn" class="control-btn">
            <i class="fas fa-expand"></i>
            <span>Fullscreen</span>
        </button>
    </div>
    
    <div class="route-container">
        <h3 style="margin-top: 0; margin-bottom: 15px;">Route Planner</h3>
        
        <div class="input-group">
            <input type="text" id="from-input" class="route-input" placeholder="From...">
            <div id="from-results" class="search-results"></div>
        </div>
        
        <div class="route-swap" id="swap-locations">
            <i class="fas fa-exchange-alt"></i> Swap
        </div>
        
        <div class="input-group">
            <input type="text" id="to-input" class="route-input" placeholder="To...">
            <div id="to-results" class="search-results"></div>
        </div>
        
        <button id="calculate-route" class="route-btn">
            <i class="fas fa-route"></i> Calculate Route
        </button>
        
        <button id="start-navigation" class="route-btn nav-btn" style="display: none;">
            <i class="fas fa-play"></i> Start Navigation
        </button>
        
        <button id="stop-navigation" class="route-btn stop-btn" style="display: none;">
            <i class="fas fa-stop"></i> Stop Navigation
        </button>
        
        <div id="route-details" class="route-details">
            <div id="route-summary" class="route-summary"></div>
            <div id="route-instructions"></div>
        </div>
    </div>
    
    <div class="navigation-popup" id="navigation-popup">
        <div class="nav-popup-header">
            <div class="nav-popup-title">Navigation</div>
            <div class="nav-popup-distance" id="nav-distance"></div>
        </div>
        <div class="nav-popup-content" id="nav-instruction">
            Ready to navigate to your destination
        </div>
        <div class="nav-popup-actions">
            <button class="nav-action-btn nav-stop-btn" id="nav-stop-btn">
                <i class="fas fa-stop"></i> Stop Navigation
            </button>
        </div>
    </div>
    
    <div class="gps-accuracy" id="gps-accuracy">
        GPS Accuracy: <span id="accuracy-value">0</span> meters
    </div>

    <script>
        // Base layers
        const lightLayer = new ol.layer.Tile({
            source: new ol.source.OSM(),
            properties: { name: 'light' }
        });
        
        const darkLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                attributions: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, © <a href="https://carto.com/attribution">CARTO</a>'
            }),
            properties: { name: 'dark' }
        });
        
        // Initialize map with light theme
        const map = new ol.Map({
            target: 'map',
            layers: [lightLayer],
            view: new ol.View({
                center: ol.proj.fromLonLat([0, 0]),
                zoom: 2
            })
        });
        
        // Route layer
        const routeLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#3a7bd5',
                    width: 6
                })
            })
        });
        map.addLayer(routeLayer);
        
        // Markers layer
        const markersLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        map.addLayer(markersLayer);
        
        // GPS position marker
        const gpsMarker = new ol.Overlay({
            positioning: 'center-center',
            element: document.createElement('div'),
            stopEvent: false
        });
        gpsMarker.getElement().className = 'gps-marker';
        map.addOverlay(gpsMarker);
        
        // Navigation variables
        let fromLocation = null;
        let toLocation = null;
        let routeData = null;
        let isNavigating = false;
        let watchId = null;
        let currentPosition = null;
        let isTracking = false;
        
        // DOM elements
        const fromInput = document.getElementById('from-input');
        const toInput = document.getElementById('to-input');
        const fromResults = document.getElementById('from-results');
        const toResults = document.getElementById('to-results');
        const swapBtn = document.getElementById('swap-locations');
        const calculateBtn = document.getElementById('calculate-route');
        const startNavBtn = document.getElementById('start-navigation');
        const stopNavBtn = document.getElementById('stop-navigation');
        const routeDetails = document.getElementById('route-details');
        const routeSummary = document.getElementById('route-summary');
        const routeInstructions = document.getElementById('route-instructions');
        const navPopup = document.getElementById('navigation-popup');
        const navInstruction = document.getElementById('nav-instruction');
        const navDistance = document.getElementById('nav-distance');
        const navStopBtn = document.getElementById('nav-stop-btn');
        const gpsTrackBtn = document.getElementById('gps-track');
        const gpsAccuracy = document.getElementById('gps-accuracy');
        const accuracyValue = document.getElementById('accuracy-value');
        const themeToggle = document.getElementById('theme-toggle');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        
        // Debounce function to limit API calls
        function debounce(func, timeout = 500) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        
        // Get current GPS position
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => resolve(position),
                        error => reject(error),
                        { enableHighAccuracy: true }
                    );
                } else {
                    reject(new Error('Geolocation is not supported by this browser'));
                }
            });
        }
        
        // Watch GPS position
        function watchPosition(callback) {
            if (navigator.geolocation) {
                return navigator.geolocation.watchPosition(
                    position => callback(position),
                    error => console.error('Geolocation error:', error),
                    { 
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 27000
                    }
                );
            }
            return null;
        }
        
        // Start GPS tracking
        function startTracking() {
            isTracking = true;
            gpsTrackBtn.innerHTML = '<i class="fas fa-location-arrow"></i><span>Following</span>';
            gpsAccuracy.style.display = 'block';
            
            watchId = watchPosition(position => {
                currentPosition = position;
                const coords = ol.proj.fromLonLat([
                    position.coords.longitude,
                    position.coords.latitude
                ]);
                
                // Update GPS marker
                gpsMarker.setPosition(coords);
                
                // Update accuracy display
                accuracyValue.textContent = Math.round(position.coords.accuracy);
                
                // Center map on position if tracking
                if (isTracking) {
                    map.getView().setCenter(coords);
                    map.getView().setZoom(17); // Close zoom level for navigation
                }
                
                // Update navigation if active
                if (isNavigating) {
                    updateNavigation(position);
                }
            });
        }
        
        // Stop GPS tracking
        function stopTracking() {
            isTracking = false;
            gpsTrackBtn.innerHTML = '<i class="fas fa-location-arrow"></i><span>Follow Me</span>';
            gpsAccuracy.style.display = 'none';
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Toggle GPS tracking
        function toggleTracking() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }
        
        // Search location using Nominatim
        async function searchLocation(query, resultsElement) {
            if (!query.trim()) {
                resultsElement.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
                const data = await response.json();
                
                resultsElement.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `
                            <div class="search-result-name">${result.display_name.split(',')[0]}</div>
                            <div class="search-result-address">${result.display_name}</div>
                        `;
                        
                        item.addEventListener('click', () => {
                            const location = {
                                name: result.display_name,
                                lon: parseFloat(result.lon),
                                lat: parseFloat(result.lat)
                            };
                            
                            if (resultsElement === fromResults) {
                                fromLocation = location;
                                fromInput.value = result.display_name;
                            } else {
                                toLocation = location;
                                toInput.value = result.display_name;
                            }
                            
                            resultsElement.style.display = 'none';
                            updateMarkers();
                        });
                        
                        resultsElement.appendChild(item);
                    });
                    
                    resultsElement.style.display = 'block';
                } else {
                    resultsElement.innerHTML = '<div class="search-result-item">No results found</div>';
                    resultsElement.style.display = 'block';
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                resultsElement.innerHTML = '<div class="search-result-item">Error fetching results</div>';
                resultsElement.style.display = 'block';
            }
        }
        
        // Update markers on the map
        function updateMarkers() {
            markersLayer.getSource().clear();
            
            if (fromLocation) {
                const fromMarker = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([fromLocation.lon, fromLocation.lat]))
                });
                
                fromMarker.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({ color: '#4CAF50' }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                    })
                }));
                
                markersLayer.getSource().addFeature(fromMarker);
            }
            
            if (toLocation) {
                const toMarker = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([toLocation.lon, toLocation.lat]))
                });
                
                toMarker.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({ color: '#F44336' }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                    })
                }));
                
                markersLayer.getSource().addFeature(toMarker);
            }
            
            if (fromLocation && toLocation) {
                const extent = ol.extent.boundingExtent([
                    ol.proj.fromLonLat([fromLocation.lon, fromLocation.lat]),
                    ol.proj.fromLonLat([toLocation.lon, toLocation.lat])
                ]);
                map.getView().fit(extent, { padding: [100, 100, 100, 100], maxZoom: 14 });
            }
        }
        
        // Calculate route using OSRM
        async function calculateRoute() {
            if (!fromLocation || !toLocation) {
                alert('Please select both start and end locations');
                return;
            }
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${fromLocation.lon},${fromLocation.lat};${toLocation.lon},${toLocation.lat}?` +
                    `overview=full&geometries=geojson&steps=true`
                );
                
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    routeData = data.routes[0];
                    
                    // Display route on map
                    const routeGeometry = new ol.format.GeoJSON().readGeometry(routeData.geometry, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    
                    routeLayer.getSource().clear();
                    routeLayer.getSource().addFeature(new ol.Feature({
                        geometry: routeGeometry
                    }));
                    
                    // Display route summary
                    const distance = (routeData.distance / 1000).toFixed(1);
                    const duration = Math.floor(routeData.duration / 60);
                    
                    routeSummary.innerHTML = `
                        <i class="fas fa-road"></i> ${distance} km | 
                        <i class="fas fa-clock"></i> ${duration} min
                    `;
                    
                    // Display route instructions
                    routeInstructions.innerHTML = '';
                    routeData.legs[0].steps.forEach((step, index) => {
                        const instruction = document.createElement('div');
                        instruction.className = 'route-instruction';
                        instruction.dataset.index = index;
                        instruction.innerHTML = `
                            <strong>${index + 1}.</strong> ${step.maneuver.instruction}
                            <div style="color: #666; font-size: 12px;">
                                ${(step.distance / 1000).toFixed(1)} km
                            </div>
                        `;
                        
                        instruction.addEventListener('click', () => {
                            highlightStep(index);
                        });
                        
                        routeInstructions.appendChild(instruction);
                    });
                    
                    routeDetails.style.display = 'block';
                    startNavBtn.style.display = 'block';
                    
                    // Fit map to route
                    map.getView().fit(routeGeometry, { padding: [100, 100, 100, 100] });
                } else {
                    alert('No route found between these locations');
                }
            } catch (error) {
                console.error('Routing error:', error);
                alert('Error calculating route. Please try again.');
            }
        }
        
        // Highlight a specific step in the route
        function highlightStep(index) {
            // Remove active class from all instructions
            const instructions = document.querySelectorAll('.route-instruction');
            instructions.forEach(inst => inst.classList.remove('active'));
            
            // Add active class to selected instruction
            instructions[index].classList.add('active');
            
            // Zoom to this step
            const step = routeData.legs[0].steps[index];
            const coordinates = step.geometry.coordinates;
            const extent = ol.extent.boundingExtent(
                coordinates.map(coord => ol.proj.fromLonLat(coord))
            );
            
            map.getView().fit(extent, { padding: [100, 100, 100, 100], maxZoom: 16 });
        }
        
        // Start navigation mode
        function startNavigation() {
            if (!routeData) return;
            
            isNavigating = true;
            
            startNavBtn.style.display = 'none';
            stopNavBtn.style.display = 'block';
            navPopup.style.display = 'block';
            
            // Ensure tracking is on
            if (!isTracking) {
                startTracking();
            }
            
            // Update navigation display
            if (currentPosition) {
                updateNavigation(currentPosition);
            }
        }
        
        // Stop navigation mode
        function stopNavigation() {
            isNavigating = false;
            
            startNavBtn.style.display = 'block';
            stopNavBtn.style.display = 'none';
            navPopup.style.display = 'none';
        }
        
        // Update navigation display based on current position
        function updateNavigation(position) {
            if (!routeData || !isNavigating) return;
            
            const userCoords = [position.coords.longitude, position.coords.latitude];
            
            // Find nearest step on route
            let nearestStep = null;
            let minDistance = Infinity;
            let stepIndex = 0;
            
            // Check each segment of the route
            for (let i = 0; i < routeData.legs[0].steps.length; i++) {
                const step = routeData.legs[0].steps[i];
                const stepCoords = step.maneuver.location;
                
                // Calculate distance to this step (simplified haversine)
                const dx = stepCoords[0] - userCoords[0];
                const dy = stepCoords[1] - userCoords[1];
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStep = step;
                    stepIndex = i;
                }
            }
            
            if (nearestStep) {
                // Calculate distance to destination
                const remainingCoords = routeData.legs[0].steps
                    .slice(stepIndex)
                    .flatMap(step => step.geometry.coordinates);
                
                remainingCoords.push([toLocation.lon, toLocation.lat]);
                
                let remainingDistance = 0;
                for (let i = 1; i < remainingCoords.length; i++) {
                    const dx = remainingCoords[i][0] - remainingCoords[i-1][0];
                    const dy = remainingCoords[i][1] - remainingCoords[i-1][1];
                    remainingDistance += Math.sqrt(dx * dx + dy * dy) * 111320; // Convert to meters (approximate)
                }
                
                // Update navigation popup
                navInstruction.textContent = nearestStep.maneuver.instruction;
                navDistance.textContent = `${Math.round(remainingDistance/1000 * 10)/10} km to destination`;
                
                // Highlight current step in instructions
                highlightStep(stepIndex);
                
                // Auto-center map when getting close to edge
                const view = map.getView();
                const extent = view.calculateExtent(map.getSize());
                const userPixel = map.getPixelFromCoordinate(
                    ol.proj.fromLonLat(userCoords)
                );
                
                const buffer = 100; // pixels from edge
                const size = map.getSize();
                
                if (userPixel[0] < buffer || 
                    userPixel[0] > size[0] - buffer || 
                    userPixel[1] < buffer || 
                    userPixel[1] > size[1] - buffer) {
                    view.setCenter(ol.proj.fromLonLat(userCoords));
                }
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            const isDark = map.getLayers().item(0).get('name') === 'dark';
            
            if (isDark) {
                map.getLayers().item(0).setProperties({ name: 'light' });
                map.getLayers().item(0).setSource(lightLayer.getSource());
                themeToggle.innerHTML = '<i class="fas fa-moon"></i><span>Night Mode</span>';
            } else {
                map.getLayers().item(0).setProperties({ name: 'dark' });
                map.getLayers().item(0).setSource(darkLayer.getSource());
                themeToggle.innerHTML = '<i class="fas fa-sun"></i><span>Day Mode</span>';
            }
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }
        
        // Swap locations
        function swapLocations() {
            if (fromLocation && toLocation) {
                const temp = fromLocation;
                fromLocation = toLocation;
                toLocation = temp;
                
                fromInput.value = fromLocation.name;
                toInput.value = toLocation.name;
                
                updateMarkers();
                
                // Recalculate route if one exists
                if (routeData) {
                    calculateRoute();
                }
            }
        }
        
        // Event listeners
        fromInput.addEventListener('input', debounce(() => {
            searchLocation(fromInput.value, fromResults);
        }));
        
        toInput.addEventListener('input', debounce(() => {
            searchLocation(toInput.value, toResults);
        }));
        
        calculateBtn.addEventListener('click', calculateRoute);
        startNavBtn.addEventListener('click', startNavigation);
        stopNavBtn.addEventListener('click', stopNavigation);
        navStopBtn.addEventListener('click', stopNavigation);
        gpsTrackBtn.addEventListener('click', toggleTracking);
        themeToggle.addEventListener('click', toggleTheme);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        swapBtn.addEventListener('click', swapLocations);
        
        // Hide results when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                fromResults.style.display = 'none';
                toResults.style.display = 'none';
            }
        });
        
        // Initialize with current position
        getCurrentPosition()
            .then(position => {
                currentPosition = position;
                const coords = ol.proj.fromLonLat([
                    position.coords.longitude,
                    position.coords.latitude
                ]);
                
                // Set as default "from" location
                fromLocation = {
                    name: "Current Location",
                    lon: position.coords.longitude,
                    lat: position.coords.latitude
                };
                fromInput.value = "Current Location";
                
                map.getView().setCenter(coords);
                map.getView().setZoom(15);
                
                // Start with tracking on
                startTracking();
            })
            .catch(error => {
                console.error('Error getting initial position:', error);
                alert('Could not get your current location. Please ensure location services are enabled.');
            });
        
        // Add attribution control
        map.addControl(new ol.control.Attribution({
            collapsible: true
        }));
    </script>
</body>
</html>
