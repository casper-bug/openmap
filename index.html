<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OSM Maps Clone - A Google Maps alternative using OpenStreetMap">
    <meta name="theme-color" content="#1a73e8">
    <title>OSM Maps</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #4285f4;
            --background-color: #ffffff;
            --text-color: #202124;
            --card-color: #ffffff;
            --border-color: #dadce0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --menu-bg: #ffffff;
            --menu-text: #202124;
            --search-bg: #ffffff;
            --map-tile-filter: none;
        }

        .dark-theme {
            --primary-color: #8ab4f8;
            --secondary-color: #669df6;
            --background-color: #202124;
            --text-color: #e8eaed;
            --card-color: #2d2e33;
            --border-color: #3c4043;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --menu-bg: #2d2e33;
            --menu-text: #e8eaed;
            --search-bg: #2d2e33;
            --map-tile-filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .leaflet-tile {
            filter: var(--map-tile-filter);
        }

        .search-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: calc(100% - 40px);
            max-width: 500px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px var(--shadow-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: var(--search-bg);
            padding: 8px 12px;
            border-radius: 8px;
        }

        #search-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            border-radius: 24px;
            background-color: var(--card-color);
            margin-right: 8px;
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        #search-input::placeholder {
            color: #80868b;
        }

        .search-results {
            background-color: var(--card-color);
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-top: 4px;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .search-result-address {
            font-size: 14px;
            color: #5f6368;
        }

        .control-buttons {
            position: absolute;
            right: 20px;
            top: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--card-color);
            border: none;
            box-shadow: 0 2px 5px var(--shadow-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .control-button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 6px var(--shadow-color);
        }

        .control-button i {
            font-size: 20px;
        }

        .hamburger-menu {
            position: absolute;
            left: 20px;
            top: 80px;
            z-index: 1000;
        }

        .menu-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--card-color);
            border: none;
            box-shadow: 0 2px 5px var(--shadow-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .menu-button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 6px var(--shadow-color);
        }

        .menu-content {
            position: absolute;
            left: 0;
            top: 60px;
            width: 280px;
            background-color: var(--menu-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 12px;
            color: var(--menu-text);
            z-index: 1001;
        }

        .menu-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-section-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--menu-text);
        }

        .menu-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            border-radius: 4px;
            padding-left: 8px;
        }

        .menu-option:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .menu-option i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        .navigation-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px var(--shadow-color);
            z-index: 1000;
            transform: translateY(150%);
            transition: transform 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }

        .navigation-panel.active {
            transform: translateY(0);
        }

        .navigation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .navigation-title {
            font-size: 18px;
            font-weight: 500;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
        }

        .route-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .time-info {
            display: flex;
            flex-direction: column;
        }

        .time-label {
            font-size: 14px;
            color: #5f6368;
        }

        .time-value {
            font-size: 20px;
            font-weight: 500;
        }

        .distance-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .distance-label {
            font-size: 14px;
            color: #5f6368;
        }

        .distance-value {
            font-size: 20px;
            font-weight: 500;
        }

        .speed-info {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 12px;
        }

        .navigation-steps {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            margin-right: 12px;
            font-size: 20px;
            color: var(--primary-color);
        }

        .step-text {
            flex: 1;
        }

        .step-distance {
            font-size: 12px;
            color: #5f6368;
        }

        .navigation-actions {
            display: flex;
            gap: 10px;
        }

        .action-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-action {
            background-color: var(--primary-color);
            color: white;
        }

        .secondary-action {
            background-color: var(--card-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .location-details {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px var(--shadow-color);
            z-index: 1000;
            transform: translateY(150%);
            transition: transform 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }

        .location-details.active {
            transform: translateY(0);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .location-title {
            font-size: 18px;
            font-weight: 500;
        }

        .location-address {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 12px;
        }

        .location-actions {
            display: flex;
            gap: 10px;
        }

        /* Loading spinner */
        .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* PWA install prompt */
        .install-prompt {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-color);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1100;
            display: none;
        }

        .install-text {
            font-size: 14px;
        }

        .install-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }

        .close-install {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-color);
        }

        @media (max-width: 600px) {
            .search-container {
                width: calc(100% - 80px);
            }
            
            .control-buttons {
                top: 80px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="map"></div>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search for places...">
            <div class="spinner" id="search-spinner"></div>
            <button class="control-button" id="voice-search-btn" title="Voice search">
                <span class="material-icons">mic</span>
            </button>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <div class="control-buttons">
        <button class="control-button" id="my-location-btn" title="My location">
            <span class="material-icons">my_location</span>
        </button>
        <button class="control-button" id="compass-btn" title="Compass mode">
            <span class="material-icons">explore</span>
        </button>
    </div>

    <div class="hamburger-menu">
        <button class="menu-button" id="menu-btn">
            <span class="material-icons">menu</span>
        </button>
        <div class="menu-content" id="menu-content">
            <div class="menu-section">
                <div class="menu-section-title">Map Display</div>
                <div class="menu-option" id="theme-option">
                    <span class="material-icons">brightness_4</span>
                    <span>Dark Mode</span>
                </div>
                <div class="menu-option" id="normal-view-option">
                    <span class="material-icons">map</span>
                    <span>Normal View</span>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Navigation</div>
                <div class="menu-option" id="avoid-tolls-option">
                    <span class="material-icons">money_off</span>
                    <span>Avoid Tolls</span>
                </div>
                <div class="menu-option" id="avoid-highways-option">
                    <span class="material-icons">directions_car</span>
                    <span>Avoid Highways</span>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-option" id="about-option">
                    <span class="material-icons">info</span>
                    <span>About & Attribution</span>
                </div>
            </div>
        </div>
    </div>

    <div class="navigation-panel" id="navigation-panel">
        <div class="navigation-header">
            <div class="navigation-title">Navigation</div>
            <button class="close-button" id="close-navigation-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="route-info">
            <div class="time-info">
                <div class="time-label">Arrival</div>
                <div class="time-value" id="arrival-time">--:--</div>
            </div>
            <div class="distance-info">
                <div class="distance-label">Distance</div>
                <div class="distance-value" id="route-distance">-- km</div>
            </div>
        </div>
        <div class="speed-info">
            Current speed: <span id="current-speed">0</span> km/h
        </div>
        <div class="navigation-steps" id="navigation-steps">
            <!-- Turn-by-turn instructions will be added here -->
        </div>
        <div class="navigation-actions">
            <button class="action-button secondary-action" id="cancel-navigation-btn">
                <span class="material-icons">close</span>
                Cancel
            </button>
            <button class="action-button primary-action" id="start-navigation-btn">
                <span class="material-icons">directions</span>
                Start
            </button>
        </div>
    </div>

    <div class="location-details" id="location-details">
        <div class="location-header">
            <div class="location-title" id="location-title">Location</div>
            <button class="close-button" id="close-details-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="location-address" id="location-address">Address not available</div>
        <div class="location-actions">
            <button class="action-button primary-action" id="navigate-to-btn">
                <span class="material-icons">directions</span>
                Navigate
            </button>
        </div>
    </div>

    <div class="install-prompt" id="install-prompt">
        <div class="install-text">Install OSM Maps for a better experience</div>
        <button class="install-button" id="install-button">Install</button>
        <button class="close-install" id="close-install-prompt">
            <span class="material-icons">close</span>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([51.505, -0.09], 13);
        
        // Add base layer with roads, waterways, and rail
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        // Current position marker
        let currentPositionMarker;
        let currentPositionCircle;
        let watchId;
        let isTracking = false;

        // Routing control
        let routingControl;
        let currentRoute;
        let isNavigating = false;
        let avoidTolls = false;
        let avoidHighways = false;

        // DOM elements
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const searchSpinner = document.getElementById('search-spinner');
        const myLocationBtn = document.getElementById('my-location-btn');
        const compassBtn = document.getElementById('compass-btn');
        const menuBtn = document.getElementById('menu-btn');
        const menuContent = document.getElementById('menu-content');
        const navigationPanel = document.getElementById('navigation-panel');
        const closeNavigationBtn = document.getElementById('close-navigation-btn');
        const cancelNavigationBtn = document.getElementById('cancel-navigation-btn');
        const startNavigationBtn = document.getElementById('start-navigation-btn');
        const locationDetails = document.getElementById('location-details');
        const closeDetailsBtn = document.getElementById('close-details-btn');
        const navigateToBtn = document.getElementById('navigate-to-btn');
        const arrivalTime = document.getElementById('arrival-time');
        const routeDistance = document.getElementById('route-distance');
        const currentSpeed = document.getElementById('current-speed');
        const navigationSteps = document.getElementById('navigation-steps');
        const installPrompt = document.getElementById('install-prompt');
        const installButton = document.getElementById('install-button');
        const closeInstallPrompt = document.getElementById('close-install-prompt');

        // Theme toggle
        const themeOption = document.getElementById('theme-option');
        const normalViewOption = document.getElementById('normal-view-option');
        const body = document.body;
        let darkTheme = false;

        // Menu options
        const avoidTollsOption = document.getElementById('avoid-tolls-option');
        const avoidHighwaysOption = document.getElementById('avoid-highways-option');
        const aboutOption = document.getElementById('about-option');

        // Initialize geocoder
        const geocoder = L.Control.Geocoder.nominatim();

        // Initialize variables for navigation
        let destinationMarker;
        let currentLocation;
        let destination;
        let routeInstructions = [];
        let currentStepIndex = 0;
        let speed = 0;

        // Event listeners
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('focus', showSearchResults);
        myLocationBtn.addEventListener('click', centerToMyLocation);
        compassBtn.addEventListener('click', toggleCompassMode);
        menuBtn.addEventListener('click', toggleMenu);
        closeNavigationBtn.addEventListener('click', hideNavigationPanel);
        cancelNavigationBtn.addEventListener('click', cancelNavigation);
        startNavigationBtn.addEventListener('click', startNavigation);
        closeDetailsBtn.addEventListener('click', hideLocationDetails);
        navigateToBtn.addEventListener('click', navigateToLocation);
        themeOption.addEventListener('click', toggleTheme);
        normalViewOption.addEventListener('click', () => {
            // Ensure normal view is selected (already is by default)
            normalViewOption.querySelector('span:not(.material-icons)').style.fontWeight = 'bold';
        });
        avoidTollsOption.addEventListener('click', toggleAvoidTolls);
        avoidHighwaysOption.addEventListener('click', toggleAvoidHighways);
        aboutOption.addEventListener('click', showAbout);
        installButton.addEventListener('click', installApp);
        closeInstallPrompt.addEventListener('click', hideInstallPrompt);

        // Check if geolocation is available
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    currentLocation = L.latLng(latitude, longitude);
                    map.setView(currentLocation, 15);
                    updatePositionMarker(currentLocation);
                    startTracking();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your location. Using default location.');
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }

        // Handle search input
        function handleSearchInput() {
            const query = searchInput.value.trim();
            if (query.length < 3) {
                searchResults.style.display = 'none';
                return;
            }

            searchSpinner.style.display = 'block';
            
            geocoder.geocode(query, (results) => {
                searchSpinner.style.display = 'none';
                
                if (!results || results.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                    searchResults.style.display = 'block';
                    return;
                }

                searchResults.innerHTML = '';
                results.slice(0, 5).forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="search-result-name">${result.name || 'Unnamed location'}</div>
                        <div class="search-result-address">${result.properties.display_name || 'Address not available'}</div>
                    `;
                    item.addEventListener('click', () => {
                        handleSearchResultClick(result);
                    });
                    searchResults.appendChild(item);
                });
                
                searchResults.style.display = 'block';
            });
        }

        function showSearchResults() {
            if (searchInput.value.trim().length >= 3 && searchResults.innerHTML !== '') {
                searchResults.style.display = 'block';
            }
        }

        function handleSearchResultClick(result) {
            const { center, properties } = result;
            const latLng = L.latLng(center.lat, center.lng);
            
            // Clear previous destination marker
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }
            
            // Add new destination marker
            destinationMarker = L.marker(latLng, {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<span class="material-icons" style="color: red; font-size: 24px;">place</span>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map);
            
            // Show location details
            showLocationDetails(result.name || 'Unnamed location', properties.display_name, latLng);
            
            // Hide search results
            searchResults.style.display = 'none';
            searchInput.value = result.name || properties.display_name;
            searchInput.blur();
            
            // Set destination for navigation
            destination = latLng;
        }

        function showLocationDetails(name, address, location) {
            document.getElementById('location-title').textContent = name;
            document.getElementById('location-address').textContent = address;
            locationDetails.classList.add('active');
            
            // Center map on the location
            map.setView(location, 15);
        }

        function hideLocationDetails() {
            locationDetails.classList.remove('active');
        }

        function navigateToLocation() {
            if (!destination) return;
            
            // Ask for starting point (default to current location)
            const startPoint = currentLocation || map.getCenter();
            calculateRoute(startPoint, destination);
            hideLocationDetails();
            showNavigationPanel();
        }

        function centerToMyLocation() {
            if (currentLocation) {
                map.setView(currentLocation, 15);
            } else {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        currentLocation = L.latLng(latitude, longitude);
                        map.setView(currentLocation, 15);
                        updatePositionMarker(currentLocation);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Unable to get your location.');
                    }
                );
            }
        }

        function toggleCompassMode() {
            isTracking = !isTracking;
            compassBtn.style.backgroundColor = isTracking ? 'var(--primary-color)' : 'var(--card-color)';
            compassBtn.style.color = isTracking ? 'white' : 'var(--text-color)';
            
            if (isTracking) {
                startTracking();
            } else {
                stopTracking();
            }
        }

        function toggleMenu() {
            menuContent.style.display = menuContent.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleTheme() {
            darkTheme = !darkTheme;
            body.classList.toggle('dark-theme', darkTheme);
            
            // Update theme icon and text
            const themeIcon = themeOption.querySelector('.material-icons');
            const themeText = themeOption.querySelector('span:not(.material-icons)');
            
            if (darkTheme) {
                themeIcon.textContent = 'brightness_7';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'brightness_4';
                themeText.textContent = 'Dark Mode';
            }
            
            // Save preference to localStorage
            localStorage.setItem('darkTheme', darkTheme);
        }

        function toggleAvoidTolls() {
            avoidTolls = !avoidTolls;
            avoidTollsOption.querySelector('span:not(.material-icons)').style.fontWeight = avoidTolls ? 'bold' : 'normal';
            
            if (currentRoute) {
                calculateRoute(currentLocation || map.getCenter(), destination);
            }
        }

        function toggleAvoidHighways() {
            avoidHighways = !avoidHighways;
            avoidHighwaysOption.querySelector('span:not(.material-icons)').style.fontWeight = avoidHighways ? 'bold' : 'normal';
            
            if (currentRoute) {
                calculateRoute(currentLocation || map.getCenter(), destination);
            }
        }

        function showAbout() {
            alert('OSM Maps Clone\n\nA Google Maps alternative using OpenStreetMap\n\n© OpenStreetMap contributors\n\nMap data © OpenStreetMap contributors, ODbL 1.0\n\nIcons by Material Icons');
        }

        function updatePositionMarker(position) {
            if (!currentPositionMarker) {
                currentPositionMarker = L.marker(position, {
                    icon: L.divIcon({
                        className: 'current-position-marker',
                        html: '<span class="material-icons" style="color: var(--primary-color); font-size: 24px;">person_pin_circle</span>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map);
                
                currentPositionCircle = L.circle(position, {
                    color: 'var(--primary-color)',
                    fillColor: 'var(--primary-color)',
                    fillOpacity: 0.2,
                    radius: 50
                }).addTo(map);
            } else {
                currentPositionMarker.setLatLng(position);
                currentPositionCircle.setLatLng(position);
            }
            
            currentLocation = position;
            
            if (isNavigating && currentRoute) {
                updateNavigation(position);
            }
        }

        function startTracking() {
            if (watchId) return;
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, accuracy, speed: currentSpeed } = position.coords;
                    const newPosition = L.latLng(latitude, longitude);
                    
                    updatePositionMarker(newPosition);
                    
                    if (isTracking) {
                        map.setView(newPosition, map.getZoom());
                    }
                    
                    // Update speed
                    speed = currentSpeed || 0;
                    document.getElementById('current-speed').textContent = Math.round(speed * 3.6); // Convert m/s to km/h
                },
                (error) => {
                    console.error('Geolocation error:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        function calculateRoute(start, end) {
            // Remove previous route if exists
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Create routing control
            routingControl = L.Routing.control({
                waypoints: [start, end],
                routeWhileDragging: true,
                showAlternatives: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                collapsible: false,
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving',
                    useHints: false
                }),
                formatter: new L.Routing.Formatter({
                    language: 'en',
                    units: 'metric'
                })
            }).addTo(map);
            
            routingControl.on('routesfound', (e) => {
                const routes = e.routes;
                if (routes && routes.length > 0) {
                    currentRoute = routes[0];
                    updateRouteInfo(currentRoute);
                }
            });
        }

        function updateRouteInfo(route) {
            // Calculate arrival time (simplified)
            const now = new Date();
            const travelTimeHours = route.summary.totalTime / 3600;
            const arrival = new Date(now.getTime() + travelTimeHours * 60 * 60 * 1000);
            
            arrivalTime.textContent = arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            routeDistance.textContent = `${(route.summary.totalDistance / 1000).toFixed(1)} km`;
            
            // Update turn-by-turn instructions
            navigationSteps.innerHTML = '';
            route.instructions.forEach((instruction, index) => {
                const step = document.createElement('div');
                step.className = 'step-item';
                step.innerHTML = `
                    <div class="step-icon">${getDirectionIcon(instruction.type)}</div>
                    <div class="step-text">${instruction.text}</div>
                    <div class="step-distance">${instruction.distance} m</div>
                `;
                navigationSteps.appendChild(step);
            });
        }

        function getDirectionIcon(type) {
            const icons = {
                'Turn left': 'turn_left',
                'Turn slight left': 'turn_slight_left',
                'Turn sharp left': 'turn_sharp_left',
                'Turn right': 'turn_right',
                'Turn slight right': 'turn_slight_right',
                'Turn sharp right': 'turn_sharp_right',
                'Continue': 'straight',
                'Roundabout': 'roundabout_left',
                'Start at': 'flag',
                'Destination reached': 'flag',
                'Enter roundabout': 'roundabout_left',
                'Leave roundabout': 'roundabout_left',
                'Head': 'straight',
                'Go straight': 'straight',
                'Fork left': 'fork_left',
                'Fork right': 'fork_right',
                'Merge': 'merge',
                'U-turn': 'u_turn_left'
            };
            
            const iconName = icons[type] || 'directions';
            return `<span class="material-icons">${iconName}</span>`;
        }

        function showNavigationPanel() {
            navigationPanel.classList.add('active');
        }

        function hideNavigationPanel() {
            navigationPanel.classList.remove('active');
        }

        function cancelNavigation() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            isNavigating = false;
            currentRoute = null;
            hideNavigationPanel();
        }

        function startNavigation() {
            isNavigating = true;
            startNavigationBtn.style.display = 'none';
            cancelNavigationBtn.innerHTML = '<span class="material-icons">close</span> End Navigation';
        }

        function updateNavigation(currentPosition) {
            if (!currentRoute) return;
            
            // Find the closest route segment to the current position
            let closestSegmentIndex = 0;
            let minDistance = Infinity;
            
            currentRoute.coordinates.forEach((coord, index) => {
                const distance = currentPosition.distanceTo(coord);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestSegmentIndex = index;
                }
            });
            
            // Update the current step in the instructions
            const steps = document.querySelectorAll('.step-item');
            steps.forEach((step, index) => {
                step.style.fontWeight = index === closestSegmentIndex ? 'bold' : 'normal';
                step.style.color = index === closestSegmentIndex ? 'var(--primary-color)' : 'var(--text-color)';
            });
        }

        // Check for saved preferences
        if (localStorage.getItem('darkTheme') === 'true') {
            toggleTheme();
        }

        // PWA installation prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.style.display = 'flex';
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }
        
        function hideInstallPrompt() {
            installPrompt.style.display = 'none';
        }

        // Service worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html><!DOCTYPE html>
<html>
<head>
    <title>Complete OSM Navigation with Live GPS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            background: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .control-btn:hover {
            background: #f5f5f5;
        }
        
        .route-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            width: 300px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .route-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .route-btn {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .nav-btn {
            background: #2196F3;
        }
        
        .nav-btn:hover {
            background: #0b7dda;
        }
        
        .stop-btn {
            background: #f44336;
        }
        
        .stop-btn:hover {
            background: #da190b;
        }
        
        .route-swap {
            text-align: center;
            margin: 5px 0;
            color: #666;
            cursor: pointer;
        }
        
        .route-swap:hover {
            color: #333;
        }
        
        .route-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: none;
        }
        
        #search-results {
            position: absolute;
            background: white;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 30px);
            z-index: 10;
            display: none;
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .route-instruction {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            cursor: pointer;
        }
        
        .route-instruction:hover {
            background: #f5f5f5;
        }
        
        .route-instruction.active {
            background: #e3f2fd;
        }
        
        .route-summary {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .navigation-popup {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            display: none;
        }
        
        .nav-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .nav-popup-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .nav-popup-close {
            cursor: pointer;
            color: #666;
        }
        
        .nav-popup-content {
            margin-bottom: 10px;
        }
        
        .nav-popup-distance {
            color: #666;
            font-size: 14px;
        }
        
        .nav-popup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .nav-action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .nav-next-btn {
            background: #4CAF50;
            color: white;
        }
        
        .nav-prev-btn {
            background: #f5f5f5;
        }
        
        .nav-stop-btn {
            background: #f44336;
            color: white;
        }
        
        .current-position-marker {
            background: #2196F3;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .gps-accuracy {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-size: 12px;
            display: none;
        }
        
        /* GPS position marker */
        .gps-marker {
            background: #4285F4;
            border-radius: 50%;
            border: 2px solid white;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .gps-marker::after {
            content: "";
            position: absolute;
            top: -8px;
            left: -8px;
            width: 30px;
            height: 30px;
            border: 2px solid #4285F4;
            border-radius: 50%;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.3; }
            70% { transform: scale(1.3); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="map-controls">
        <button id="gps-track" class="control-btn">
            <i class="fas fa-location-arrow"></i>
            <span>Follow Me</span>
        </button>
        
        <button id="theme-toggle" class="control-btn">
            <i class="fas fa-moon"></i>
            <span>Night Mode</span>
        </button>
        
        <button id="fullscreen-btn" class="control-btn">
            <i class="fas fa-expand"></i>
            <span>Fullscreen</span>
        </button>
    </div>
    
    <div class="route-container">
        <h3 style="margin-top: 0; margin-bottom: 15px;">Route Planner</h3>
        
        <div class="input-group">
            <input type="text" id="from-input" class="route-input" placeholder="From...">
            <div id="from-results" class="search-results"></div>
        </div>
        
        <div class="route-swap" id="swap-locations">
            <i class="fas fa-exchange-alt"></i> Swap
        </div>
        
        <div class="input-group">
            <input type="text" id="to-input" class="route-input" placeholder="To...">
            <div id="to-results" class="search-results"></div>
        </div>
        
        <button id="calculate-route" class="route-btn">
            <i class="fas fa-route"></i> Calculate Route
        </button>
        
        <button id="start-navigation" class="route-btn nav-btn" style="display: none;">
            <i class="fas fa-play"></i> Start Navigation
        </button>
        
        <button id="stop-navigation" class="route-btn stop-btn" style="display: none;">
            <i class="fas fa-stop"></i> Stop Navigation
        </button>
        
        <div id="route-details" class="route-details">
            <div id="route-summary" class="route-summary"></div>
            <div id="route-instructions"></div>
        </div>
    </div>
    
    <div class="navigation-popup" id="navigation-popup">
        <div class="nav-popup-header">
            <div class="nav-popup-title">Navigation</div>
            <div class="nav-popup-distance" id="nav-distance"></div>
        </div>
        <div class="nav-popup-content" id="nav-instruction">
            Ready to navigate to your destination
        </div>
        <div class="nav-popup-actions">
            <button class="nav-action-btn nav-stop-btn" id="nav-stop-btn">
                <i class="fas fa-stop"></i> Stop Navigation
            </button>
        </div>
    </div>
    
    <div class="gps-accuracy" id="gps-accuracy">
        GPS Accuracy: <span id="accuracy-value">0</span> meters
    </div>

    <script>
        // Base layers
        const lightLayer = new ol.layer.Tile({
            source: new ol.source.OSM(),
            properties: { name: 'light' }
        });
        
        const darkLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                attributions: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, © <a href="https://carto.com/attribution">CARTO</a>'
            }),
            properties: { name: 'dark' }
        });
        
        // Initialize map with light theme
        const map = new ol.Map({
            target: 'map',
            layers: [lightLayer],
            view: new ol.View({
                center: ol.proj.fromLonLat([0, 0]),
                zoom: 2
            })
        });
        
        // Route layer
        const routeLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#3a7bd5',
                    width: 6
                })
            })
        });
        map.addLayer(routeLayer);
        
        // Markers layer
        const markersLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        map.addLayer(markersLayer);
        
        // GPS position marker
        const gpsMarker = new ol.Overlay({
            positioning: 'center-center',
            element: document.createElement('div'),
            stopEvent: false
        });
        gpsMarker.getElement().className = 'gps-marker';
        map.addOverlay(gpsMarker);
        
        // Navigation variables
        let fromLocation = null;
        let toLocation = null;
        let routeData = null;
        let isNavigating = false;
        let watchId = null;
        let currentPosition = null;
        let isTracking = false;
        
        // DOM elements
        const fromInput = document.getElementById('from-input');
        const toInput = document.getElementById('to-input');
        const fromResults = document.getElementById('from-results');
        const toResults = document.getElementById('to-results');
        const swapBtn = document.getElementById('swap-locations');
        const calculateBtn = document.getElementById('calculate-route');
        const startNavBtn = document.getElementById('start-navigation');
        const stopNavBtn = document.getElementById('stop-navigation');
        const routeDetails = document.getElementById('route-details');
        const routeSummary = document.getElementById('route-summary');
        const routeInstructions = document.getElementById('route-instructions');
        const navPopup = document.getElementById('navigation-popup');
        const navInstruction = document.getElementById('nav-instruction');
        const navDistance = document.getElementById('nav-distance');
        const navStopBtn = document.getElementById('nav-stop-btn');
        const gpsTrackBtn = document.getElementById('gps-track');
        const gpsAccuracy = document.getElementById('gps-accuracy');
        const accuracyValue = document.getElementById('accuracy-value');
        const themeToggle = document.getElementById('theme-toggle');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        
        // Debounce function to limit API calls
        function debounce(func, timeout = 500) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        
        // Get current GPS position
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => resolve(position),
                        error => reject(error),
                        { enableHighAccuracy: true }
                    );
                } else {
                    reject(new Error('Geolocation is not supported by this browser'));
                }
            });
        }
        
        // Watch GPS position
        function watchPosition(callback) {
            if (navigator.geolocation) {
                return navigator.geolocation.watchPosition(
                    position => callback(position),
                    error => console.error('Geolocation error:', error),
                    { 
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 27000
                    }
                );
            }
            return null;
        }
        
        // Start GPS tracking
        function startTracking() {
            isTracking = true;
            gpsTrackBtn.innerHTML = '<i class="fas fa-location-arrow"></i><span>Following</span>';
            gpsAccuracy.style.display = 'block';
            
            watchId = watchPosition(position => {
                currentPosition = position;
                const coords = ol.proj.fromLonLat([
                    position.coords.longitude,
                    position.coords.latitude
                ]);
                
                // Update GPS marker
                gpsMarker.setPosition(coords);
                
                // Update accuracy display
                accuracyValue.textContent = Math.round(position.coords.accuracy);
                
                // Center map on position if tracking
                if (isTracking) {
                    map.getView().setCenter(coords);
                    map.getView().setZoom(17); // Close zoom level for navigation
                }
                
                // Update navigation if active
                if (isNavigating) {
                    updateNavigation(position);
                }
            });
        }
        
        // Stop GPS tracking
        function stopTracking() {
            isTracking = false;
            gpsTrackBtn.innerHTML = '<i class="fas fa-location-arrow"></i><span>Follow Me</span>';
            gpsAccuracy.style.display = 'none';
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Toggle GPS tracking
        function toggleTracking() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }
        
        // Search location using Nominatim
        async function searchLocation(query, resultsElement) {
            if (!query.trim()) {
                resultsElement.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
                const data = await response.json();
                
                resultsElement.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `
                            <div class="search-result-name">${result.display_name.split(',')[0]}</div>
                            <div class="search-result-address">${result.display_name}</div>
                        `;
                        
                        item.addEventListener('click', () => {
                            const location = {
                                name: result.display_name,
                                lon: parseFloat(result.lon),
                                lat: parseFloat(result.lat)
                            };
                            
                            if (resultsElement === fromResults) {
                                fromLocation = location;
                                fromInput.value = result.display_name;
                            } else {
                                toLocation = location;
                                toInput.value = result.display_name;
                            }
                            
                            resultsElement.style.display = 'none';
                            updateMarkers();
                        });
                        
                        resultsElement.appendChild(item);
                    });
                    
                    resultsElement.style.display = 'block';
                } else {
                    resultsElement.innerHTML = '<div class="search-result-item">No results found</div>';
                    resultsElement.style.display = 'block';
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                resultsElement.innerHTML = '<div class="search-result-item">Error fetching results</div>';
                resultsElement.style.display = 'block';
            }
        }
        
        // Update markers on the map
        function updateMarkers() {
            markersLayer.getSource().clear();
            
            if (fromLocation) {
                const fromMarker = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([fromLocation.lon, fromLocation.lat]))
                });
                
                fromMarker.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({ color: '#4CAF50' }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                    })
                }));
                
                markersLayer.getSource().addFeature(fromMarker);
            }
            
            if (toLocation) {
                const toMarker = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([toLocation.lon, toLocation.lat]))
                });
                
                toMarker.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({ color: '#F44336' }),
                        stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                    })
                }));
                
                markersLayer.getSource().addFeature(toMarker);
            }
            
            if (fromLocation && toLocation) {
                const extent = ol.extent.boundingExtent([
                    ol.proj.fromLonLat([fromLocation.lon, fromLocation.lat]),
                    ol.proj.fromLonLat([toLocation.lon, toLocation.lat])
                ]);
                map.getView().fit(extent, { padding: [100, 100, 100, 100], maxZoom: 14 });
            }
        }
        
        // Calculate route using OSRM
        async function calculateRoute() {
            if (!fromLocation || !toLocation) {
                alert('Please select both start and end locations');
                return;
            }
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${fromLocation.lon},${fromLocation.lat};${toLocation.lon},${toLocation.lat}?` +
                    `overview=full&geometries=geojson&steps=true`
                );
                
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    routeData = data.routes[0];
                    
                    // Display route on map
                    const routeGeometry = new ol.format.GeoJSON().readGeometry(routeData.geometry, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    
                    routeLayer.getSource().clear();
                    routeLayer.getSource().addFeature(new ol.Feature({
                        geometry: routeGeometry
                    }));
                    
                    // Display route summary
                    const distance = (routeData.distance / 1000).toFixed(1);
                    const duration = Math.floor(routeData.duration / 60);
                    
                    routeSummary.innerHTML = `
                        <i class="fas fa-road"></i> ${distance} km | 
                        <i class="fas fa-clock"></i> ${duration} min
                    `;
                    
                    // Display route instructions
                    routeInstructions.innerHTML = '';
                    routeData.legs[0].steps.forEach((step, index) => {
                        const instruction = document.createElement('div');
                        instruction.className = 'route-instruction';
                        instruction.dataset.index = index;
                        instruction.innerHTML = `
                            <strong>${index + 1}.</strong> ${step.maneuver.instruction}
                            <div style="color: #666; font-size: 12px;">
                                ${(step.distance / 1000).toFixed(1)} km
                            </div>
                        `;
                        
                        instruction.addEventListener('click', () => {
                            highlightStep(index);
                        });
                        
                        routeInstructions.appendChild(instruction);
                    });
                    
                    routeDetails.style.display = 'block';
                    startNavBtn.style.display = 'block';
                    
                    // Fit map to route
                    map.getView().fit(routeGeometry, { padding: [100, 100, 100, 100] });
                } else {
                    alert('No route found between these locations');
                }
            } catch (error) {
                console.error('Routing error:', error);
                alert('Error calculating route. Please try again.');
            }
        }
        
        // Highlight a specific step in the route
        function highlightStep(index) {
            // Remove active class from all instructions
            const instructions = document.querySelectorAll('.route-instruction');
            instructions.forEach(inst => inst.classList.remove('active'));
            
            // Add active class to selected instruction
            instructions[index].classList.add('active');
            
            // Zoom to this step
            const step = routeData.legs[0].steps[index];
            const coordinates = step.geometry.coordinates;
            const extent = ol.extent.boundingExtent(
                coordinates.map(coord => ol.proj.fromLonLat(coord))
            );
            
            map.getView().fit(extent, { padding: [100, 100, 100, 100], maxZoom: 16 });
        }
        
        // Start navigation mode
        function startNavigation() {
            if (!routeData) return;
            
            isNavigating = true;
            
            startNavBtn.style.display = 'none';
            stopNavBtn.style.display = 'block';
            navPopup.style.display = 'block';
            
            // Ensure tracking is on
            if (!isTracking) {
                startTracking();
            }
            
            // Update navigation display
            if (currentPosition) {
                updateNavigation(currentPosition);
            }
        }
        
        // Stop navigation mode
        function stopNavigation() {
            isNavigating = false;
            
            startNavBtn.style.display = 'block';
            stopNavBtn.style.display = 'none';
            navPopup.style.display = 'none';
        }
        
        // Update navigation display based on current position
        function updateNavigation(position) {
            if (!routeData || !isNavigating) return;
            
            const userCoords = [position.coords.longitude, position.coords.latitude];
            
            // Find nearest step on route
            let nearestStep = null;
            let minDistance = Infinity;
            let stepIndex = 0;
            
            // Check each segment of the route
            for (let i = 0; i < routeData.legs[0].steps.length; i++) {
                const step = routeData.legs[0].steps[i];
                const stepCoords = step.maneuver.location;
                
                // Calculate distance to this step (simplified haversine)
                const dx = stepCoords[0] - userCoords[0];
                const dy = stepCoords[1] - userCoords[1];
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStep = step;
                    stepIndex = i;
                }
            }
            
            if (nearestStep) {
                // Calculate distance to destination
                const remainingCoords = routeData.legs[0].steps
                    .slice(stepIndex)
                    .flatMap(step => step.geometry.coordinates);
                
                remainingCoords.push([toLocation.lon, toLocation.lat]);
                
                let remainingDistance = 0;
                for (let i = 1; i < remainingCoords.length; i++) {
                    const dx = remainingCoords[i][0] - remainingCoords[i-1][0];
                    const dy = remainingCoords[i][1] - remainingCoords[i-1][1];
                    remainingDistance += Math.sqrt(dx * dx + dy * dy) * 111320; // Convert to meters (approximate)
                }
                
                // Update navigation popup
                navInstruction.textContent = nearestStep.maneuver.instruction;
                navDistance.textContent = `${Math.round(remainingDistance/1000 * 10)/10} km to destination`;
                
                // Highlight current step in instructions
                highlightStep(stepIndex);
                
                // Auto-center map when getting close to edge
                const view = map.getView();
                const extent = view.calculateExtent(map.getSize());
                const userPixel = map.getPixelFromCoordinate(
                    ol.proj.fromLonLat(userCoords)
                );
                
                const buffer = 100; // pixels from edge
                const size = map.getSize();
                
                if (userPixel[0] < buffer || 
                    userPixel[0] > size[0] - buffer || 
                    userPixel[1] < buffer || 
                    userPixel[1] > size[1] - buffer) {
                    view.setCenter(ol.proj.fromLonLat(userCoords));
                }
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            const isDark = map.getLayers().item(0).get('name') === 'dark';
            
            if (isDark) {
                map.getLayers().item(0).setProperties({ name: 'light' });
                map.getLayers().item(0).setSource(lightLayer.getSource());
                themeToggle.innerHTML = '<i class="fas fa-moon"></i><span>Night Mode</span>';
            } else {
                map.getLayers().item(0).setProperties({ name: 'dark' });
                map.getLayers().item(0).setSource(darkLayer.getSource());
                themeToggle.innerHTML = '<i class="fas fa-sun"></i><span>Day Mode</span>';
            }
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }
        
        // Swap locations
        function swapLocations() {
            if (fromLocation && toLocation) {
                const temp = fromLocation;
                fromLocation = toLocation;
                toLocation = temp;
                
                fromInput.value = fromLocation.name;
                toInput.value = toLocation.name;
                
                updateMarkers();
                
                // Recalculate route if one exists
                if (routeData) {
                    calculateRoute();
                }
            }
        }
        
        // Event listeners
        fromInput.addEventListener('input', debounce(() => {
            searchLocation(fromInput.value, fromResults);
        }));
        
        toInput.addEventListener('input', debounce(() => {
            searchLocation(toInput.value, toResults);
        }));
        
        calculateBtn.addEventListener('click', calculateRoute);
        startNavBtn.addEventListener('click', startNavigation);
        stopNavBtn.addEventListener('click', stopNavigation);
        navStopBtn.addEventListener('click', stopNavigation);
        gpsTrackBtn.addEventListener('click', toggleTracking);
        themeToggle.addEventListener('click', toggleTheme);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        swapBtn.addEventListener('click', swapLocations);
        
        // Hide results when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                fromResults.style.display = 'none';
                toResults.style.display = 'none';
            }
        });
        
        // Initialize with current position
        getCurrentPosition()
            .then(position => {
                currentPosition = position;
                const coords = ol.proj.fromLonLat([
                    position.coords.longitude,
                    position.coords.latitude
                ]);
                
                // Set as default "from" location
                fromLocation = {
                    name: "Current Location",
                    lon: position.coords.longitude,
                    lat: position.coords.latitude
                };
                fromInput.value = "Current Location";
                
                map.getView().setCenter(coords);
                map.getView().setZoom(15);
                
                // Start with tracking on
                startTracking();
            })
            .catch(error => {
                console.error('Error getting initial position:', error);
                alert('Could not get your current location. Please ensure location services are enabled.');
            });
        
        // Add attribution control
        map.addControl(new ol.control.Attribution({
            collapsible: true
        }));
    </script>
</body>
</html>
